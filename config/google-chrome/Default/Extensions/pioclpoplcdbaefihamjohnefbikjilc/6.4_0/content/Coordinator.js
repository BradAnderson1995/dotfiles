/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function Coordinator(){function a(a){T&&(T.getElement()&&T.getElement().parentNode&&T.getElement().parentNode.removeChild(T.getElement()),a&&T.destroy()),a&&(T=null),document.documentElement.classList.remove("skitchWaiting","skitchReady")}function b(b){!Q.classList.contains("evernoteClipperVisible")||document.documentElement.classList.contains("evernoteOptionsOpen")?(Q.classList.remove("evernoteClipperVisible"),r()):(Q.addEventListener("webkitTransitionEnd",r),Q.classList.remove("evernoteClipperVisible")),R&&R.parentNode&&(R.parentNode.removeChild(R),R=null),document.documentElement.classList.remove("evernoteOptionsOpen"),contentPreview.clear(),a(b.notClipping),b.notClipping&&(contentPreview.reset(),contentPreview.clearHighlights()),window.removeEventListener("keydown",t),window.removeEventListener("keypress",u),window.removeEventListener("mousedown",v),window.removeEventListener("unload",w),Browser.sendToExtension({name:"showLoggedInOrOutState"})}function c(a){"function"==typeof Y[a.keycode]&&Y[a.keycode](a.keycode,null,!0)}function d(){document.documentElement.classList.add("skitchWaiting")}function e(a,c,d){document.documentElement.classList.contains("evernoteOptionsOpen")?j({authed:!0}):Q.classList.contains("evernoteClipperVisible")&&(d?b({notClipping:!0}):Browser.sendToExtension({name:"bounce",message:{name:"gt_handleEscape",keycode:a}}))}function f(a){Q.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&("notebook"===a?Browser.sendToExtension({name:"bounce",message:{name:"gt_openNotebook"}}):"tags"===a&&Browser.sendToExtension({name:"bounce",message:{name:"gt_openTags"}}))}function g(a){Q.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&("expand"==a?contentPreview.expandPreview():"contract"==a?contentPreview.contractPreview():"up"==a?contentPreview.moveToElementAbove():"down"==a&&contentPreview.moveToElementBelow())}function h(a,b){X&&Y[a]&&Y[a](a,b)}function i(a,b){Y[a]&&Y[a](a,b)}function j(a){a.authed?(Browser.sendToExtension({name:"bounce",message:{name:"gt_reactivateClipperTool"}}),R&&R.parentNode&&(R.parentNode.removeChild(R),R=null),document.documentElement.classList.remove("evernoteOptionsOpen")):b({notClipping:!0})}function k(){Browser.sendToExtension({name:"getKeyboardShortcuts",shortcuts:["startWebClipperShortcut"]}),Q=document.createElement("iframe"),Q.id="evernoteGlobalTools",Q.addEventListener("load",function(){Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",handlers:Z,enabled:X}}),x()}),Q.src=Browser.extension.getURL("content/global_tools/global_tools.html")}function l(){D(),document.documentElement.appendChild(Q),window.addEventListener("keydown",t),window.addEventListener("keypress",u),window.addEventListener("mousedown",v),window.addEventListener("unload",w),Browser.sendToExtension({name:"getKeyboardShortcuts",shortcuts:["closeWebClipperShortcut","previewArticleShortcut","previewFullPageShortcut","previewUrlShortcut","selectionModeShortcut","takeScreenshotShortcut","clearlyShortcut","pdfShortcut","emailShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut","selectNotebookShortcut","addTagsShortcut","saveShortcut","arrowShortcut","textShortcut","rectangleShortcut","roundedRectangleShortcut","ellipseShortcut","lineShortcut","markerShortcut","highlighterShortcut","stampShortcut","pixelateShortcut","cropShortcut"]}),_++}function m(a){X=a.keyboardShortcutsEnabled;var b={};for(var c in a.keys){var d=a.keys[c].split("|"),j=d.join(" + ");if(b[j]=h,Z[c]=[j],"startWebClipperShortcut"==c?Y[j]=J:"closeWebClipperShortcut"==c?(b[j]=i,Y[j]=e,$[c]=[j]):"previewArticleShortcut"==c?Y[j]=function(){H("article")}:"previewFullPageShortcut"==c?Y[j]=function(){H("fullPage")}:"previewUrlShortcut"==c?Y[j]=function(){H("url")}:"selectionModeShortcut"==c?Y[j]=function(){H("selection")}:"takeScreenshotShortcut"==c?Y[j]=function(){H("screenshot")}:"clearlyShortcut"==c?Y[j]=function(){H("clearly")}:"pdfShortcut"==c?Y[j]=function(){H("pdf")}:"emailShortcut"==c?Y[j]=function(){H("email")}:"expandArticleShortcut"==c?(b[j]=i,Y[j]=function(){g("expand")}):"contractArticleShortcut"==c?(b[j]=i,Y[j]=function(){g("contract")}):"moveArticleUpShortcut"==c?(b[j]=i,Y[j]=function(){g("up")}):"moveArticleDownShortcut"==c?(b[j]=i,Y[j]=function(){g("down")}):"selectNotebookShortcut"==c?Y[j]=function(){f("notebook")}:"addTagsShortcut"==c?Y[j]=function(){f("tags")}:"saveShortcut"==c?Y[j]=z:"arrowShortcut"==c?Y[j]=function(){I("shapes","arrow")}:"textShortcut"==c?Y[j]=function(){I("text")}:"rectangleShortcut"==c?Y[j]=function(){I("shapes","rectangle")}:"roundedRectangleShortcut"==c?Y[j]=function(){I("shapes","roundedRectangle")}:"ellipseShortcut"==c?Y[j]=function(){I("shapes","ellipse")}:"lineShortcut"==c?Y[j]=function(){I("shapes","line")}:"markerShortcut"==c?Y[j]=function(){I("marker")}:"highlighterShortcut"==c?Y[j]=function(){I("highlighter")}:"stampShortcut"==c?Y[j]=function(){I("stamps")}:"pixelateShortcut"==c?Y[j]=function(){I("pixelate")}:"cropShortcut"==c&&(Y[j]=function(){I("crop")}),d.indexOf("91")>-1){var k=JSON.parse(JSON.stringify(d));/windows/i.test(window.navigator.userAgent)?(k[d.indexOf("91")]="17",k.sort(function(a,b){return a-b}),Y[k.join(" + ")]=Y[j],delete Y[j],b[k.join(" + ")]=b[j],delete b[j],Z[c]&&(Z[c][0]=k.join(" + ")),$[c]&&($[c][0]=k.join(" + "))):(k[d.indexOf("91")]="93",k.sort(function(a,b){return a-b}),Y[k.join(" + ")]=Y[j],b[k.join(" + ")]=b[j],Z[c]&&Z[c].push(k.join(" + ")),$[c]&&$[c].push(k.join(" + ")))}}Browser.addKeyboardHandlers(b),Q&&Q.parentNode&&Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",handlers:Z,enabled:X}})}function n(a){X=a.keyboardShortcutsEnabled,Browser.sendToExtension({name:"bounce",message:{name:"gt_setKeyboardHandlers",enabled:X}}),Browser.sendToExtension({name:"bounce",message:{name:"op_setKeyboardHandlers",enabled:X}})}function o(a){T=Markup({allowZoom:!1,container:document.body,document:a.data,margin:0,enableToolbar:!1,fullScreen:!0,success:function(){document.documentElement.classList.add("skitchReady"),T.toast(Browser.i18n.getMessage("screenshotToast")),Browser.sendToExtension({name:"bounce",message:{name:"skitchSurfaceReady"}})}}),T.on("toolStarted",function(a){Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:a})}),T.on("toolStopped",function(a){"crop"===a&&Q.style.removeProperty("display")}),T.localize({CROP_APPLY_TEXT:Browser.i18n.getMessage("apply"),CROP_CANCEL_TEXT:Browser.i18n.getMessage("regForm_cancel"),MARKUP_STAMP_APPROVED_TEXT:Browser.i18n.getMessage("approved"),MARKUP_STAMP_EXCLAIM_TEXT:Browser.i18n.getMessage("wow"),MARKUP_STAMP_PERFECT_TEXT:Browser.i18n.getMessage("perfect"),MARKUP_STAMP_QUESTION_TEXT:Browser.i18n.getMessage("what"),MARKUP_STAMP_REJECTED_TEXT:Browser.i18n.getMessage("rejected"),ZOOM_RESET_TEXT:Browser.i18n.getMessage("reset"),ZOOM_TIP_TEXT:Browser.i18n.getMessage("panInstruction")})}function p(a,c,d){return K()?(y(),void(Q.classList.contains("evernoteClipperVisible")?b({notClipping:!0}):(clipResultCoordinator.hideClipResult(!1),C(a)))):(aa=[a,c,d],void l())}function q(a){"string"==typeof a.oldShortcut&&(a.oldShortcut=[a.oldShortcut],a.shortcut=[a.shortcut],a.shortcutName=[a.shortcutName]);for(var b=0;b<a.oldShortcut.length;b++){var c=a.oldShortcut[b].split("|").join(" + "),d=a.shortcut[b].split("|").join(" + ");Y[d]=Y[c],delete Y[c];var e={};e[d]=["closeWebClipperShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut"].indexOf(a.shortcutName[b])>-1?i:h,Browser.addKeyboardHandlers(e)}}function r(){Q&&(Q.removeEventListener("webkitTransitionEnd",r),Q.parentNode&&Q.parentNode.removeChild(Q)),_=0}function s(a){"opacity"===a.propertyName&&(Browser.sendToExtension({name:"getOption",option:"defaultClipAction"}),Q.removeEventListener("webkitTransitionEnd",s))}function t(a){/Mac OS X/.test(window.navigator.userAgent)?a.metaKey&&a.preventDefault():/Windows/.test(window.navigator.userAgent)&&a.ctrlKey&&a.preventDefault(),[8,13,27,39,37,65,70,66,83,77,80,69,67].indexOf(a.keyCode)>-1?document.documentElement.classList.contains("skitchReady")||document.documentElement.classList.contains("skitchWaiting")||a.preventDefault():9===a.keyCode&&Q.focus()}function u(a){if(document.documentElement.classList.contains("skitchReady")&&!document.querySelector("textarea.skitch-tool-element-text-editor")){var b=T.getElement().offsetWidth/2,c=T.getElement().offsetHeight/2;Browser.sendToExtension({name:"bounce",message:{name:"gt_useSkitchTool",tool:"text",loc:{x:b,y:c},charCode:a.charCode}}),a.preventDefault()}}function v(a){Q.classList.contains("evernoteClipperVisible")?a.srcElement!==document.documentElement&&contentPreview.isPointOnVeil(a.pageX,a.pageY)&&a.preventDefault():document.documentElement.classList.contains("evernoteOptionsOpen")&&a.preventDefault()}function w(){Browser.sendToExtension({name:"showLoggedInOrOutState"})}function x(){_++,aa.length>0&&K()&&(p(aa[0],aa[1],aa[2]),aa=[]),window.focus()}function y(){S&&S.parentNode&&S.parentNode.removeChild(S)}function z(){Q.classList.contains("evernoteClipperVisible")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_save"}})}function A(a){Q.style.setProperty("height",a.height+"px","important")}function B(a){a.height>window.innerHeight?(R.style.setProperty("height",window.innerHeight+"px","important"),R.style.setProperty("top","-webkit-calc(50% - "+window.innerHeight/2+"px)","important"),Browser.sendToExtension({name:"bounce",message:{name:"op_setPinchHeight",totalHeight:window.innerHeight}})):(R.style.setProperty("height",a.height+"px","important"),R.style.setProperty("top","-webkit-calc(50% - "+a.height/2+"px)","important"))}function C(a){a&&(Browser.sendToExtension({name:"main_recordActivity"}),V=a.bizUser,W=a.bizComplete,Browser.sendToExtension({name:"bounce",message:{name:"gt_initialize",ssoRequired:V&&!W,title:pageInfo.getTitle()}}),Browser.sendToExtension({name:"bounce",message:{name:"gt_setPossibleClipTypes",pageInfo:{pdf:pageInfo.getPdfUrl(),documentIsFrameset:pageInfo.documentIsFrameset,selection:pageInfo.getSelection()?!0:!1,gmail:pageInfo.isGmail(),gmailThread:pageInfo.isGmailThread()}}}),U=UUID.generateGuid(),Browser.sendToExtension({name:"getSmartFilingInfo",recText:pageInfo.getRecommendationText(!1),pendingNoteKey:U,url:pageInfo.getUrl()})),Q.addEventListener("webkitTransitionEnd",s),Q.classList.add("evernoteClipperVisible"),Browser.sendToExtension({name:"showOpenState"}),Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"gmailTooltip"}}),Browser.sendToExtension({name:"bounce",message:{name:"ttc_close",which:"pdfTooltip"}})}function D(){S=document.createElement("div"),S.id="evernoteLoading",document.body.appendChild(S)}function E(){R||(R=document.createElement("iframe"),R.id="evernoteOptionsPage",R.addEventListener("load",function(){Browser.sendToExtension({name:"bounce",message:{name:"op_setKeyboardHandlers",handlers:$,enabled:X}})}),R.src=Browser.extension.getURL("options.html#iframe")),document.documentElement.appendChild(R),document.documentElement.classList.add("evernoteOptionsOpen"),contentPreview.gray(),R.focus()}function F(){new TooltipCoordinator(Browser.extension.getURL("content/tooltips/tooltip.html#authed=true&which=ssoInProgress"),"ssoInProgress","evernoteSSOProgress")}function G(a){function c(b,c){"screenshot"===a.clipType?a.screenshotUrl?b():T.getFile(function(a){T.destroy(),T=null,b({bytes:a.bytes,byteLength:a.bytes.byteLength})}):"clearly"===a.clipType?clipper.clipClearly(b,c):"article"===a.clipType?clipper.clipArticle(!0,b,c):"fullPage"===a.clipType?clipper.clipFullPage(!0,b,c):"selection"===a.clipType?clipper.clipSelection(!0,a.selectionText,b,c):"url"===a.clipType?clipper.clipUrl(b):"pdf"===a.clipType?clipper.clipPdf(b):"email"===a.clipType?clipper.clipEmail(b,c):"image"===a.clipType&&clipper.clipImage(a.imageUrl,b)}b({notClipping:!1});var d=a.title;"string"!=typeof d&&(d=pageInfo.getTitle()),d=GlobalUtils.removeControlCharacters(d).trim(),d||(d=Browser.i18n.getMessage("quickNote_untitledNote"));var e=pageInfo.getUrl(),f=null;a.contextMenu&&(f=pageInfo.getRecommendationText(!1)),clipResultCoordinator.showClipResult(U,d,e,f,function(){c(function(b){var c={name:"submitNote",title:d,notebook:a.notebook,tags:a.tags,comment:a.comment,clipType:a.clipType,url:e,userSelectedNotebook:a.userSelectedNotebook,pendingNoteKey:U,smartFilingNotebookAvailable:a.smartFilingNotebookAvailable,changedSmartFilingNotebook:a.changedSmartFilingNotebook};"screenshot"===a.clipType?a.screenshotUrl?c.content='<img src="'+a.screenshotUrl+'"></img>':(c.content='<img src="resource:0"></img>',c.resources=[b]):c.content=b,Browser.sendToExtension(c),contentPreview.reset()},function(b){Browser.sendToExtension({name:"submitNote",clipType:a.clipType,error:b.stack,pendingNoteKey:U,smartFilingNotebookAvailable:a.smartFilingNotebookAvailable,changedSmartFilingNotebook:a.changedSmartFilingNotebook}),contentPreview.reset()})})}function H(a){Q.classList.contains("evernoteClipperVisible")&&!document.documentElement.classList.contains("skitchReady")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_useClipType",clipType:a}})}function I(a,b){document.documentElement.classList.contains("skitchReady")&&Browser.sendToExtension({name:"bounce",message:{name:"gt_useSkitchTool",tool:a,subtool:b}})}function J(a,b){b&&(["INPUT","TEXTAREA"].indexOf(b.nodeName)>-1||"true"===b.contentEditable)||Browser.sendToExtension({name:"toggleClipper"},function(){alert("The Clipper couldn't start on this page. Reload the page and try again. If that doesn't help, contact customer support.")})}function K(){return 2===_}function L(a){(V!==a.bizUser||W!==a.bizComplete)&&(Browser.sendToExtension({name:"bounce",message:{name:"gt_updateUser",ssoRequired:a.bizUser&&!a.bizComplete}}),Browser.sendToExtension({name:"getSmartFilingInfo",recText:pageInfo.getRecommendationText(!1),pendingNoteKey:U,url:pageInfo.getUrl()}),V=a.bizUser,W=a.bizComplete)}function M(a){T.updateSelectedElementsColor(a.color),T.useColor(a.color),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"color",label:a.color})}function N(a){T.useTool(a.tool),"crop"===a.tool?(Q.style.setProperty("display","none","important"),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"crop"})):"text"===a.tool&&a.loc&&a.charCode&&T.startActiveTool(a.loc,{value:String.fromCharCode(a.charCode),selectOnFocus:!1})}function O(){T.zoom(1.1,{x:window.innerWidth/2,y:window.innerHeight/2}),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"zoom_in"})}function P(){T.zoom(1/1.1,{x:window.innerWidth/2,y:window.innerHeight/2}),Browser.sendToExtension({name:"trackEvent",category:"Skitch",action:"zoom_out"})}var Q,R,S,T,U,V,W,X=!0,Y={},Z={},$={},_=0,aa=[];this.msgHandlerToggleCoordinator=p,Browser.addMessageHandlers({closeClipper:b,duplicateKeyboardShortcut:c,goToSkitchWaitingMode:d,hideOptions:j,receiveKeyboardShortcuts:m,receiveKeyboardShortcutsEnabled:n,receiveScreenshot:o,setGlobalToolsHeight:A,setOptionsHeight:B,showOptions:E,showSSOProgressTooltip:F,startSubmission:G,toggleCoordinator:p,updateKeyboardShortcut:q,updateUserTier:L,skitch_useColor:M,skitch_useTool:N,skitch_zoomIn:O,skitch_zoomOut:P}),k(),Object.preventExtensions(this)}Object.preventExtensions(Coordinator);