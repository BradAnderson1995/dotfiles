/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function Extension(){"use strict";function a(){Persistent.get("deviceID")||Persistent.set("deviceID",UUID.generateGuid().slice(0,32))}function b(){Persistent.get("localStoragePurged")||(Persistent.set("localStoragePurged",!0),delete localStorage.savedAuthInfo,delete localStorage.userCache)}function c(a){if(!a)return void log.warn("Version out of date!");if(!ab){if(ab=!0,b(),Sa=new BootstrapInfo(options.get("overrideServiceURL")),auth=new Auth(options.get("overrideServiceURL"),options.get("secureProto")),X(),d(),versionDetect.getLastVersionParsed()[0]<=5&&6===versionDetect.getSourceVersionParsed()[0]&&auth.logoutAll(),6!==versionDetect.getSourceVersionParsed()[0])throw new Error("check if need to update version");auth.getUserInfo().authenticationToken&&(auth.getUserInfo().version||0)<Auth.VERSION?auth.updateUserStatus(Z):Z(),firstTime.startUp(),p(),s(),t(),firstTime.msgHandlerOnInit(function(){p()}),G({startup:!0}),auth.getCurrentUser()&&z({category:"Install or Update",action:"set_user_cd",data:B()}),u(),Y()}}function d(){if(!SAFARI){if(Ya)return;Ya=!0,chrome.contextMenus.removeAll(function(){o()})}}function e(){alert(Browser.i18n.getMessage("contextMenuPleaseLogin"))}function f(a){var b=safari.application.activeBrowserWindow.activeTab,c=a.userInfo;switch(a.command){case bb.clipPage:i(b);break;case bb.clipScreenshot:j(b);break;case bb.clipSelection:k(c,b);break;case bb.clipImage:l(c,b);break;case bb.clipPDF:m(b);break;case bb.clipUrl:n(b)}}function g(a){var b=a.userInfo;if(b&&b.url){if(!b.url.match(/^https?/i))return;if(b.url.match(/^https?:\/\/extensions.apple.com/i))return}a.contextMenu.appendContextMenuItem(bb.clipPage,Browser.i18n.getMessage("safariContextClipPage"),bb.clipPage),a.contextMenu.appendContextMenuItem(bb.clipScreenshot,Browser.i18n.getMessage("safariContextClipScreenshot"),bb.clipScreenshot),a.userInfo&&a.userInfo.selection&&a.contextMenu.appendContextMenuItem(bb.clipSelection,Browser.i18n.getMessage("safariContextClipSelection"),bb.clipSelection),a.userInfo&&a.userInfo.node&&"img"==a.userInfo.node.toLowerCase()&&a.contextMenu.appendContextMenuItem(bb.clipImage,Browser.i18n.getMessage("safariContextClipImage"),bb.clipImage),a.userInfo&&a.userInfo.pdf&&a.contextMenu.appendContextMenuItem(bb.clipPDF,Browser.i18n.getMessage("safariContextClipPDF"),bb.clipPDF),a.contextMenu.appendContextMenuItem(bb.clipUrl,Browser.i18n.getMessage("safariContextClipUrl"),bb.clipUrl)}function h(a){return a.plus?"Plus":a.bizAuthenticationToken?"Business":a.premium?"Premium":"Basic"}function i(a){Va.recordActivity(auth.isAuthenticated),J(a.url)||auth.isAuthenticated(function(b){b?Browser.sendToTab(a,{name:"startSubmission",clipType:"fullPage",contextMenu:!0,smartFilingNotebookAvailable:!1}):e()})}function j(a){Va.recordActivity(auth.isAuthenticated),J(a.url)||auth.isAuthenticated(function(b){b?Oa({contextMenu:!0},{tab:a},function(b){Browser.sendToTab(a,{name:"startSubmission",clipType:"screenshot",contextMenu:!0,screenshotUrl:b,smartFilingNotebookAvailable:!1})}):e()})}function k(a,b){Va.recordActivity(auth.isAuthenticated),J(b.url)||auth.isAuthenticated(function(c){c?Browser.sendToTab(b,{name:"startSubmission",clipType:"selection",contextMenu:!0,selectionText:a.selectionText,smartFilingNotebookAvailable:!1}):e()})}function l(a,b){Va.recordActivity(auth.isAuthenticated),J(b.url)||auth.isAuthenticated(function(c){c?Browser.sendToTab(b,{name:"startSubmission",clipType:"image",contextMenu:!0,imageUrl:a.srcUrl,smartFilingNotebookAvailable:!1}):e()})}function m(a){Va.recordActivity(auth.isAuthenticated),J(a.url)||auth.isAuthenticated(function(b){b?Browser.sendToTab(a,{name:"startSubmission",clipType:"pdf",contextMenu:!0,smartFilingNotebookAvailable:!1}):e()})}function n(a){Va.recordActivity(auth.isAuthenticated),J(a.url)||auth.isAuthenticated(function(b){b?Browser.sendToTab(a,{name:"startSubmission",clipType:"url",contextMenu:!0,smartFilingNotebookAvailable:!1}):e()})}function o(){Ya=!1;var a=["http://*/*","https://*/*"],b=["http://*/*","https://*/*","chrome-extension://encfpfilknmenlmjemepncnlbbjlabkc/*","chrome-extension://oemmndcbldboiebfnladdacbdfmadadm/*"];chrome.contextMenus.create({id:"fullPage",title:Browser.i18n.getMessage("contextMenuClipPage"),contexts:["page","image","selection"],documentUrlPatterns:a}),chrome.contextMenus.create({id:"screenshot",title:Browser.i18n.getMessage("contextMenuClipScreenshot"),contexts:["page","image","selection"],documentUrlPatterns:a}),chrome.contextMenus.create({id:"selection",title:Browser.i18n.getMessage("contextMenuClipSelection"),contexts:["selection"],documentUrlPatterns:b}),chrome.contextMenus.create({id:"image",title:Browser.i18n.getMessage("contextMenuClipImage"),contexts:["image"],targetUrlPatterns:a}),chrome.contextMenus.create({id:"pdf",title:Browser.i18n.getMessage("contextMenuClipPDF"),contexts:["all"],documentUrlPatterns:b}),chrome.contextMenus.create({id:"url",title:Browser.i18n.getMessage("contextMenuClipUrl"),contexts:["all"],documentUrlPatterns:b}),chrome.contextMenus.onClicked.addListener(function(a,b){switch(a.menuItemId){case"fullPage":i(b);break;case"screenshot":j(b);break;case"selection":k(a,b);break;case"image":l(a,b);break;case"pdf":m(b);break;case"url":n(b)}})}function p(){if(SAFARI){var a=function(a,b){if(a&&"clipper"==a.identifier){b&&!/login\.html/.test(a.contentWindow.location.href)&&(a.contentWindow.location.href=Xa);var c=a.contentWindow.location.href;/login\.html/.test(c)?(a.height=oa()>1?365:336,a.width=313):/registration\.html/.test(c)?(a.width=589,a.height=440):/two_factor\.html/.test(c)?(a.width=313,a.height=325):/sso\.html/.test(c)&&(a.width=298,a.height=350)}};safari.application.removeEventListener("validate",function(b){a(b.target.popover)}),safari.application.addEventListener("validate",function(b){a(b.target.popover)}),safari.application.removeEventListener("popover",function(b){a(b.target,!0)}),safari.application.addEventListener("popover",function(b){a(b.target,!0)})}firstTime.needToShowIntro()?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(){firstTime.msgHandlerOnAction(function(){p(),G()})})):auth.isAuthenticated(function(a){a?(Browser.setPopup(""),Browser.setBrowserActionClickHandler(function(a){auth.isAuthenticated(function(b){if(b){var c={pers:b.authenticationToken};if(b.bizAuthenticationToken&&(c.biz=b.bizAuthenticationToken),w(a)){var d=na("marketingUrl")+"/webclipper/guide";return Browser.closeTab(a),Ta=null,Ua=null,void qa(d,function(a){r(a,function(a){x(null,{tab:a})})})}x(null,{tab:a})}else log.warn("logged out while toggling coordinator")})})):(Browser.removeBrowserActionClickHandler(),Browser.setPopup(Xa))})}function q(a){if(console.log("Autorun"),a.id===_a.tabId&&_a.callback){var b=_a.callback;_a.tabId=_a.callback=null,console.log("Executed"),b(a)}}function r(a,b){_a.tabId=a.id,_a.callback=b}function s(){function a(a){SAFARI?(G(),a.target.browserWindow?Browser.sendToTab(a.target,{name:"isExtensionOpen"}):a.target.activeTab&&Browser.sendToTab(a.target.activeTab,{name:"isExtensionOpen"})):(G(),Browser.sendToTab({id:a.tabId},{name:"isExtensionOpen"}))}SAFARI?safari.application.addEventListener("activate",a,!0):(chrome.tabs.onActivated.addListener(a),chrome.windows.onFocusChanged.addListener(function(b){chrome.tabs.query({active:!0,windowId:b},function(b){b&&b.length>0?a({tabId:b[0].id}):log.warn("chrome tabs query did not return a result while changing window focus")})}))}function t(){function a(){auth.getUserInfo().authenticationToken&&auth.updateUserStatus(Z)}var b=/^https:\/\/(?:app|www|stage|stage-china)\.(?:evernote|yinxiang)\.com\/subscriptions/;SAFARI?safari.application.addEventListener("beforeNavigate",function(c){b.test(c.target.url)&&a()}):(chrome.tabs.onUpdated.addListener(function(c,d){d.url&&b.test(d.url)?Wa=c:Wa===c&&d.url&&a()}),chrome.tabs.onRemoved.addListener(function(a){Wa===a&&(Wa=0)}))}function u(){}function v(a){Browser.sendToTab(a,{name:"toggleCoordinator",baseUrl:options.get("secureProto")+Sa.get("serviceHost"),userId:"fake",username:Browser.i18n.getMessage("fleFakeUser"),authTokens:{},premium:!1,fullName:Browser.i18n.getMessage("fleFakeUser"),dontStartPreview:!0}),Browser.sendToTab(a,{name:"startTour"})}function w(a){return"undefined"==typeof Ta||"undefined"==typeof Ua?!1:a.id===Ta&&a.url===Ua}function x(a,b){auth.isAuthenticated(function(a){a?(Browser.sendToTab(b.tab,{name:"insertSerializationScripts"}),Browser.sendToTab(b.tab,{name:"setFavIconUrl",favIconUrl:b.tab.favIconUrl?b.tab.favIconUrl:"http://www.google.com/s2/favicons?domain="+encodeURIComponent(b.tab.url)}),Browser.sendToTab(b.tab,{name:"toggleCoordinator",bizUser:!!a.businessId,bizComplete:!!a.bizAuthenticationToken},function(){chrome&&chrome.runtime&&chrome.runtime.lastError&&alert(Browser.i18n.getMessage("popup_couldntStart"))})):log.error("logged out while toggling clipper.")})}function y(a,b,c,d,e){var f=[],g=Math.max(3-a.length,2),h=[],i=[];a||(a=[]),c||(c=[]);for(var j=0;j<c.length&&!(h.length>=g&&i.length>=g);j++)c[j].shardId=d,c[j].inBusinessNotebook=!0,e[c[j].notebookGuid].joined?h.push(c[j]):(c[j].notebookName=e[c[j].notebookGuid].name,i.push(c[j]));for(var k=Math.min(g,h.length),l=Math.max(g-k,1),m=Math.min(l,i.length),n=h.slice(0,g-m),j=0;m>j;j++)n.push(i[j]);f=a.slice(0,3-n.length);for(var j=0;j<n.length;j++)f.push(n[j]);for(var j=0;j<f.length;j++)f[j].shardId||(f[j].shardId=b);return f}function z(a){auth.getCurrentUser()&&(a.data||(a.data=[]),a.data.push({slot:Analytics.CD.USER_TYPE,value:h(auth.getUserInfo())})),Analytics.trackEvent(a.category,a.action,a.label,a.value,a.startSession,a.endSession,a.data)}function A(a){Analytics.trackTiming(a.category,a.variableName,a.time,a.label)}function B(){var a=[{slot:Analytics.CD.SERVICE_HOST,value:na("serviceHost")},{slot:Analytics.CD.DEVICE_ID,value:Persistent.get("deviceID")}];return a.push(/china/i.test(na("name"))?{slot:Analytics.CD.GLOBAL_USER_ID,value:"YX"+auth.getCurrentUser()}:{slot:Analytics.CD.GLOBAL_USER_ID,value:"EN"+auth.getCurrentUser()}),auth.getUserInfo().businessId&&a.push({slot:Analytics.CD.BUSINESS_VAULT_ID,value:auth.getUserInfo().businessId}),a}function C(){Browser.setTitle(Browser.i18n.getMessage("webClipperUpdated")),Browser.setIcon("images/wc6-update")}function D(){return firstTime.isUpgraded()?void C():(Browser.setTitle(Browser.i18n.getMessage("BrowserActionTitle")),void Browser.setIcon("images/web-clipper"))}function E(){return firstTime.isUpgraded()?void C():(Browser.setTitle(Browser.i18n.getMessage("signInPrompt")),void Browser.setIcon("images/web-clipper-sign-in"))}function F(){Browser.setIcon("images/close-ext")}function G(a){return firstTime.isUpgraded()?void C():void(auth.getUserInfo().authenticationToken?a&&a.startup||D():E())}function H(a,b,c){if(Sa.getLength()>1){var d=Sa.getIndex();d=(d+1)%2,Sa.setIndex(d),c()}}function I(a){return a=(a+"").toLowerCase(),a.match(/^https?:\/\/chrome.google.com\/(extensions|webstore)/)?!0:!1}function J(a){return I(a)?(alert(Browser.i18n.getMessage("illegalUrlClipFailure")),!0):!1}function K(a,b){b&&b.tab&&Browser.sendToTab(b.tab,{name:"receivePersistentValue",key:a.key,value:Persistent.get(a.key),currentUserId:auth.getCurrentUser()})}function L(a){Persistent.set(a.key,a.value)}function M(a){var b=Persistent.get(a.key);b||(b={}),b[a.userId]=a.value,Persistent.set(a.key,b)}function N(a){var b=Persistent.get(a.key);b||(b=0),b+=a.delta,Persistent.set(a.key,b)}function O(a,b){function c(){db[this.req.url]?(Browser.sendToTab(b.tab,{name:"receiveThumbnail",guid:this.req.guid,datauri:db[this.req.url]}),cb.shift(),cb.length>0&&c.call(cb[0])):this.req.send(this.payload)}var d=new XMLHttpRequest;d.url=a.url,d.guid=a.guid,d.open(a.method||"POST",a.url),d.responseType="arraybuffer",d.onreadystatechange=function(){if(4===this.readyState){if(200===this.status){for(var a="",d=new Uint8Array(this.response),e=0;e<d.length;e++)a+=String.fromCharCode(d[e]);db[this.url]="data:"+this.getResponseHeader("Content-type")+";base64,"+btoa(a),Browser.sendToTab(b.tab,{name:"receiveThumbnail",guid:this.guid,datauri:db[this.url]})}else if(401===this.status&&this.url){var f=new XMLHttpRequest;return f.open("POST",options.get("secureProto")+Sa.get("serviceHost")+"/SetAuthToken.action?auth="+encodeURIComponent(auth.getUserInfo().authenticationToken)+"&targetUrl="+encodeURIComponent(this.url)),f.guid=this.guid,f.responseType="arraybuffer",f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.onreadystatechange=this.onreadystatechange,void f.send(cb[0].payload)}cb.shift(),cb.length>0&&c.call(cb[0])}},d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),cb.push("note"===a.type?a.inBusinessNotebook?{req:d,payload:"size="+a.size+"&auth="+encodeURIComponent(auth.getUserInfo().bizAuthenticationToken)}:{req:d,payload:"size="+a.size+"&auth="+encodeURIComponent(auth.getUserInfo().authenticationToken)}:"evernote_user"===a.type?{req:d,payload:"size="+a.size}:"google_user"===a.type?{req:d,payload:""}:{req:d,payload:""}),1===cb.length&&c.call(cb[0])}function P(a,b){var c=new Image;c.onload=function(){var d=document.createElement("canvas");d.width=Math.min(150,a.width),d.height=Math.min(150,a.height);var e=d.getContext("2d");e.drawImage(c,Math.max(0,(a.width-150)/2),Math.max(0,(a.height-150)/2),d.width,d.height,0,0,d.width,d.height),Browser.sendToTab(b.tab,{name:"receiveCroppedImage",datauri:d.toDataURL(),url:a.url})},c.src=a.url}function Q(a,b,c){Browser.sendToTab(b.tab,{name:"l10nData",data:Browser.i18n._getL10nData()}),c&&c()}function R(a,b,c){for(var d in a.options)options.set(d,a.options[d]);c&&c()}function S(a,b){options.clear(a.options);var c={};for(var d in a.options)c[a.options[d]]=options.get(a.options[d]);Browser.sendToTab(b.tab,{name:"optionsCleared",options:c})}function T(a,b){b.tab&&Browser.sendToTab(b.tab,a.message)}function U(a){Browser.getAllTabs(function(b){for(var c=0;c<b.length;c++)Browser.sendToTab(b[c],a.message)})}function V(){log.log("Got restart message..."),Browser.removeMessageHandlers(),window.location.reload()}function W(a,b,c){function d(c){if("simSearch"==a.type)Browser.sendToTab(b.tab,{name:"simSearch_isAuthenticated",auth:c});else if("clipResult"==a.type)Browser.sendToTab(b.tab,{name:"clipResult_isAuthenticated",auth:c});else if("options"==a.type)Browser.sendToTab(b.tab,{name:"options_isAuthenticated",auth:c});else if("pdfTooltip"==a.type){var d=Persistent.get(c.userId+"_pdfTooltipShown");Persistent.set(c.userId+"_pdfTooltipShown",!0);var e={name:"pdfTooltip_isAuthenticated",auth:c,pdfTooltipShown:d};if(a.bootstrapInfo){e.bootstrapInfo={};for(var f in a.bootstrapInfo)e.bootstrapInfo[f]=Sa.get(f)}Browser.sendToTab(b.tab,e)}else if("tooltip"==a.type){var e={name:"tooltip_isAuthenticated",auth:c};if(a.bootstrapInfo){e.bootstrapInfo={};for(var f in a.bootstrapInfo)e.bootstrapInfo[f]=Sa.get(f)}Browser.sendToTab(b.tab,e)}else"ewc"===a.type&&Browser.sendToTab(b.tab,{name:"ewc_isAuthenticated",auth:c,baseUrl:ka("secureProto")+na("serviceHost")})}auth.isAuthenticated(b&&b.tab?d:c)}function X(){!Va&&auth&&(Va=new UsageMetricsManager(options.get("secureProto")+Sa.get("serviceHost"),auth.isAuthenticated,options.get("secureProto"),Sa.get("serviceHost"),options.get("overrideServiceURL"),auth.updateUserStatus,[Z]))}function Y(){var a=Persistent.get("lastActiveTimes");a||(a={});var b=auth.getCurrentUser();b=b?b:"unauthed",a[b]||(a[b]={time:(new Date).getTime(),count:0}),a.unauthed||(a.unauthed={time:(new Date).getTime(),count:0}),Persistent.set("lastActiveTimes",a)}function Z(a){var b=Persistent.get("basicUpsellTimes");b||(b={});var c=auth.getCurrentUser();c&&(auth.getUserInfo().basic&&(!b[c]||a&&a.forceUpdate)?(b[c]=(new Date).getTime()+2592e6,Persistent.set("basicUpsellTimes",b)):auth.getUserInfo().basic||(delete b[c],Persistent.set("basicUpsellTimes",b)))}function $(a,b,c){Ta=b.tab.id,Ua=b.tab.url,v(b.tab),c&&c()}function _(a,b,c){var d=w(b.tab);Browser.sendToTab(b.tab,{name:"isTouring",data:d}),c&&c()}function aa(){Ta=null,Ua=null}function ba(a,b){var c=new XMLHttpRequest;c.onreadystatechange=function(){4===c.readyState&&Browser.sendToTab(b.tab,{name:"receiveXMLHttpRequest",response:c.responseText})},c.open("GET",a.url),c.send()}function ca(a,b){b&&b.tab&&q(b.tab)}function da(a,b,c){auth.login(a.username,a.password,function(a){a.error||(!a.bizAuthenticationToken&&!a.bizName||Persistent.get(a.userId+"_turnedOffSearchHelper")||options.set("useSearchHelper",!0),a.username&&(Browser.setBrowserActionClickHandler(function(a){x(null,{tab:a})}),Browser.setPopup("")),Z()),c(a)})}function ea(a,b){auth.logoutAll(a.authExpired),Browser.sendToTab(b.tab,{name:"logoutCallback"}),Browser.removeBrowserActionClickHandler(),Browser.setPopup(Xa),Persistent.clear("BootstrapInfoIndex"),Persistent.clear("BootstrapInfo"),wa()}function fa(a,b,c){var d="clipper_chr";SAFARI?d="clipper_saf":OPERA?d="clipper_op":YANDEX&&(d="clipper_yan");var e=new FormData;e.append("code",d);var f=new XMLHttpRequest;f.open("POST",options.get("secureProto")+Sa.get("serviceHost")+"/CreateUserJSON.action?",!0),f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var a=JSON.parse(f.response);c({captcha:a.captcha,submit:a.submit})}else 0==f.status?(log.error("couldn't get registration form links because of network error"),c({error:"NETWORK"})):4==f.readyState&&log.error("couldn't get registration form links because of error: "+f.status)},f.send(e)}function ga(a,b){Browser.sendToTab(b.tab,{name:"getInfo"})}function ha(a,b){function c(){var c;"Google"!==a.info.searchEngine&&r.bizAuthenticationToken?(c=e(),Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:c,type:"all",tokens:{pers:r.authenticationToken,biz:r.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(r.userId+"_noSimsearchResultsShown")})):(c=d(),Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:c[0],type:"account",isBizUser:Boolean(r.bizAuthenticationToken),tokens:{pers:r.authenticationToken,biz:r.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(r.userId+"_noSimsearchResultsShown")}),r.bizAuthenticationToken&&Browser.sendToTab(b.tab,{name:"simsearch_receiveRelatedNotes",relatedNotes:c[1],type:"library",tokens:{pers:r.authenticationToken,biz:r.bizAuthenticationToken},noSimsearchResultsShown:Persistent.get(r.userId+"_noSimsearchResultsShown")}))}function d(){if(r.bizAuthenticationToken){for(var a=[],b=[],c=0;c<p.length&&!(a.length>=3&&b.length>=3);)p[c].shardId=n.shardId,p[c].inBusinessNotebook=!0,t[p[c].notebookGuid].joined?a.push(p[c]):(p[c].notebookName=t[p[c].notebookGuid].name,p[c].contact=p[c].attributes.lastEditedBy||p[c].attributes.author||t[p[c].notebookGuid].contact,b.push(p[c])),c++;var d=Math.max(3-a.length,1),e=Math.min(d,b.length);p=a.slice(0,3-e);for(var f=0;e>f;f++)p.push(b[f]);q.length>0&&(p[Math.max(0,p.length-1)]=q[0]);var g=[];return o.length>0&&(g[0]=o),p.length>0&&(g[1]=p),g}return o.length>0?[o]:[]}function e(){for(var a=Math.max(3-o.length,2),b=[],c=[],d=0;d<p.length&&!(b.length>=a&&c.length>=a);d++)p[d].shardId=n.shardId,p[d].inBusinessNotebook=!0,t[p[d].notebookGuid].joined?b.push(p[d]):(p[d].notebookName=t[p[d].notebookGuid].name,p[d].contact=p[d].attributes.lastEditedBy||p[d].attributes.author||t[p[d].notebookGuid].contact,c.push(p[d]));for(var e=Math.min(a,b.length),f=Math.max(a-e,1),g=Math.min(f,c.length),h=b.slice(0,a-g),d=0;g>d;d++)h.push(c[d]);for(var i=o.slice(0,3-h.length),d=0;d<h.length;d++)i.push(h[d]);return q.length>0&&(i[Math.max(0,i.length-1)]=q[0]),i.length>0?i:null}function f(d,e){d?(o=d.relatedNotes?d.relatedNotes.list:[],d.debugInfo&&(u.write("QUERY",a.info.query),u.write("TEXT",a.info.recommendationText),u.write("DEBUG_INFO",d.debugInfo)),(r.bizAuthenticationToken&&p&&q||!r.bizAuthenticationToken)&&c()):ya(e,b.tab)}function g(a,d){if(a){if(a.relatedNotes){for(var e=0;e<a.containingNotebooks.list.length;e++){var f=a.containingNotebooks.list[e];t[f.guid]={joined:f.hasSharedNotebook,name:f.notebookDisplayName,contact:f.contactName}}p=a.relatedNotes.list}else p=[];a.debugInfo&&u.write("DEBUG_INFO",a.debugInfo),o&&q&&c()}else ya(d,b.tab)}function h(a,d){q=[],a?a.experts&&a.experts.list&&a.experts.list.length>0&&q.push({title:a.experts.list[0].name,id:a.experts.list[0].id,type:"expert",role:a.experts.list[0].attributes?a.experts.list[0].attributes.title:null}):ya(d,b.tab),o&&p&&c()}function i(){var b={includeTitle:!0,includeUpdated:!0,includeAttributes:!0,includeNotebookGuid:!0};options.get("includeDebugInfo")&&(b.includeDebugInfo=!0);var c={url:a.info.url,text:a.info.recommendationText,query:a.info.query,relatedNotesResultSpec:b},d=options.get("relatedNotesContext").trim();return""!=d&&(c.context=d),c}function j(){JsonQueue.handleExpensiveOpRequest({shardId:m.shardId,userId:r.userId,type:"pers"},m.client.NoteStoreExtra.getFilingRecommendations,f,r.authenticationToken,i())}function k(){JsonQueue.handleExpensiveOpRequest({shardId:n.shardId,userId:r.userId,type:"biz"},n.client.NoteStoreExtra.getFilingRecommendations,g,r.bizAuthenticationToken,i()),n.client.NoteStore.findRelated(h,r.bizAuthenticationToken,{plainText:a.info.query},{maxExperts:1})}function l(a){r=a,s=options.get("secureProto")+Sa.get("serviceHost"),m=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.listLinkedNotebooks"],s,options.get("secureProto"),Sa.get("serviceHost"),options.get("overrideServiceURL")),m.initWithAuthToken(r.authenticationToken,j),r.bizAuthenticationToken&&(n=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations","NoteStore.findRelated"],s,options.get("secureProto"),Sa.get("serviceHost"),options.get("overrideServiceURL")),n.initWithAuthToken(r.bizAuthenticationToken,k))}var m,n,o,p,q,r,s,t={},u=new LogWriter("relatedNotesDebugInfo");a.info.recommendationText&&a.info.query&&auth.isAuthenticated(l)}function ia(a,b){function c(){if(this.readyState==this.DONE){var a={name:"content_textResource",href:this.href};200==this.status&&(a.responseText=this.responseText),Browser.sendToTab(b.tab,a)}}if(a&&a.href){var d=new XMLHttpRequest;d.href=a.href,d.open("GET",a.href),d.onreadystatechange=c,d.send()}}function ja(a,b,c){if(b&&b.tab){var d={name:"config"};if(a.returnName&&(d.name=a.returnName),a.options){d.options={};for(var e in a.options)d.options[e]=options.get(e)}if(a.bootstrapInfo){d.bootstrapInfo={};for(var e in a.bootstrapInfo)Sa&&(d.bootstrapInfo[e]=Sa.get(e))}Browser.sendToTab(b.tab,d),c&&c(d)}}function ka(a){return options.get(a)}function la(a,b){if(a.name="receiveOption","defaultClipAction"==a.option)if(a.key="clipAction","lastUsed"==options.get("defaultClipAction")){var c=Persistent.get("lastUsedAction");a.value=c?c:"ARTICLE"}else a.value=options.get("clipAction");else a.key=a.option,a.value=options.get(a.key);delete a.option,Browser.sendToTab(b.tab,a)}function ma(a,b){options.set(a,b)}function na(a){return Sa?Sa.get(a):""}function oa(){return Sa?Sa.getLength():0}function pa(a,b,c){qa(a.url),c&&c()}function qa(a,b){if(SAFARI){var c=safari.application.activeBrowserWindow.openTab();c.url=a,b&&b(c)}else chrome.tabs.create({url:a,selected:!0},b)}function ra(a,b,c){var d=600,e=600,f="";if(a.width&&(d=a.width),a.height&&(e=a.height),a.url&&(f=a.url),f)if(SAFARI){var g=safari.application.openBrowserWindow();g.activeTab.url=f,c&&c()}else chrome.windows.create({url:f,width:d,height:e,type:a.type,top:a.top,left:a.left},function(){c&&c()})}function sa(a,b,c){try{Va.recordActivity()}catch(d){log.error("Failed to record user activity: "+d.trace||d.stack||JSON.stringify(d))}c&&c()}function ta(a){SAFARI||a.show!=Za&&(Za=a.show,a.show?d():chrome.contextMenus.remove("pdf"))}function ua(a){Browser.insertCSS(a.filename)}function va(a,b){function c(a){return!Persistent.get(a+"_sawRatingsPrompt")&&Persistent.get(a+"_successfulClipsCount")>=10}function d(a){return auth.getUserInfo().basic&&Persistent.get(a+"_sawReferralCount")<5&&Persistent.get(a+"_clipsCount_referral")>=20}function e(a){var b=Persistent.get("sawWorkchatPromo");return!b||!b[a]}function f(a){if("basicUpsell"===ka("simulateClippingError"))return!0;var b=Persistent.get("basicUpsellTimes");return b&&b[a]&&new Date>=b[a]&&auth.getUserInfo().basic?!0:!1}function g(a){var b=(a-0)%10;return b>=0&&3>=b?!1:b>=4&&5>=b?{version:"A"}:b>=6&&7>=b?{version:"B"}:{version:"C"}}function h(a,b){if("nearQuota"===ka("simulateClippingError"))return!0;var c=Persistent.get("shownNearQuotaUpsell");if(!c||!c[a]){var d=auth.getUserInfo(a).quota,e=Persistent.get("uploaded"),f=b;if(e&&e[a]&&(f+=e[a]),auth.getUserInfo().premium){if(f>=d-262144e3)return!0}else if(f/d>=.75)return!0}return!1}function i(b,c,d){var e=new Submitter({submit:b,authenticationToken:c.authenticationToken,bizAuthenticationToken:c.bizAuthenticationToken},{noteSizeMax:c.noteSizeMax},m,{submit:d},function(a){j(a,c)});e.createNoteWithThrift(a.title,a.notebook.guid,a.notebook.name,a.notebook.noShareNotes,a.notebook.type,a.tags,a.comment,a.url,a.clipType,a.content,a.resources)}function j(i,j){if("fail"===i.name)i.name="handleFailure",Persistent.get(j.userId+"_sawRatingsPrompt")||Persistent.clear(j.userId+"_successfulClipsCount"),Persistent.get(j.userId+"_sawReferralCount")<5&&Persistent.clear(j.userId+"_clipsCount_referral"),Browser.sendToTab(b.tab,i),delete $a[a.pendingNoteKey];else if("success"===i.name){if(i.name="handleSuccess",!Persistent.get(j.userId+"_sawRatingsPrompt")){var k=Persistent.get(j.userId+"_successfulClipsCount");k||(k=0),Persistent.set(j.userId+"_successfulClipsCount",++k)}Persistent.get(j.userId+"_sawReferralCount")<5&&(k=Persistent.get(j.userId+"_clipsCount_referral"),k||(k=0),Persistent.set(j.userId+"_clipsCount_referral",++k)),e(j.userId)?i.showWorkchat=!0:c(j.userId)?i.showRatings=!0:h(j.userId,i.noteSize)?i.nearQuota=!0:d(j.userId)?i.showReferral=!0:f(j.userId)&&(i.showBasicUpsell=g(j.userId)),delete i.noteSize,Browser.sendToTab(b.tab,i),delete $a[a.pendingNoteKey]}else"showSyncing"===i.name&&Browser.sendToTab(b.tab,{name:"showSyncing"})}$a[a.pendingNoteKey]||($a[a.pendingNoteKey]={}),$a[a.pendingNoteKey].note=a,$a[a.pendingNoteKey].originatingTab=b;var k=[];if(a.smartFilingNotebookAvailable){var l="accepted_notebook_suggestion";a.changedSmartFilingNotebook&&(l="changed_from_",a.changedSmartFilingNotebook.from.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?l+="personal":a.changedSmartFilingNotebook.from.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(l+="business"),l+="_to_",l+=a.changedSmartFilingNotebook.to.defaultNotebook?"default":a.changedSmartFilingNotebook.to.recentNotebook?"last_used":"another",l+="_",a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?l+="personal":a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?l+="shared":a.changedSmartFilingNotebook.to.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(l+="business"),l+="_notebook"),k.push({slot:Analytics.CD.SMART_FILING,value:l})}k.push({slot:Analytics.CD.TAG,value:a.tags&&a.tags.length>0?"added_tags":"no_tags"}),k.push({slot:Analytics.CD.COMMENTS,value:a.comment&&a.comment.trim()?"added_comments":"no_comments"}),k.push({slot:Analytics.CD.EXPORT_TO_DB,value:1}),z({category:"Clip",action:a.clipType,startSession:!0,data:k}),a.notebook||(a.notebook={type:GlobalUtils.NOTEBOOK_TYPE_PERSONAL});var m=options.get("secureProto")+Sa.get("serviceHost");auth.isAuthenticated(function(c){if(a.error)return log.error((b&&b.tab?b.tab.url+"\n\n":"")+a.error),b&&b.tab&&b.tab.url&&z({category:"Errors",action:"Serializer: "+a.error.substr(0,200),label:b.tab.url}),void j({name:"fail",error:a.error},c);if(a.userSelectedNotebook&&a.notebook.guid){var d=Persistent.get("recentNotebooks");d||(d={}),d[c.userId]=a.notebook.guid,Persistent.set("recentNotebooks",d)}a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?i(c.authenticationToken,c,c.userId):a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_LINKED?new RSVP.Promise(function(b,d){La(a.notebook.shardId).authenticateToSharedNotebook(a.notebook.globalId,c.authenticationToken,b,d)}).then(function(a){i(a.authenticationToken,c,a.user.id)},function(a){log.error("Error authenticating to shared notebook: "+a.__proto__.name+JSON.stringify(a)),j({name:"fail",error:a},c)}):a.notebook.type===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&i(c.bizAuthenticationToken,c,c.bizUserId)})}function wa(){if(a(),xa()){var b=new Bootstrapper(options.get("simulateSimplifiedChinese"),options.get("useStage"),options.get("overrideServiceURL"),options.get("secureProto"));b.bootstrap(c,!0)}else c(!0)}function xa(){var a=Persistent.get("previousLang");return navigator.language!==a?(Persistent.set("previousLang",navigator.language),!0):Persistent.hasKey("BootstrapInfoIndex")&&Persistent.hasKey("BootstrapInfo")?!1:!0}function ya(a,b){(/PERMISSION_DENIED/.test(a.trace)||/AUTH_EXPIRED/.test(a.trace))&&/parameter:authenticationToken\)/.test(a.trace)?(ea({authExpired:!0},{tab:b}),b&&Browser.sendToTab(b,{name:"tellUserToLogin"})):log.error(a.trace||a.message||a.stack||a)}function za(a,b){Browser.sendToTab(b.tab,{name:"receivePersistentFlag",key:a.key,value:Persistent.get(a.key)}),a.set&&Persistent.set(a.key,a.setValue)}function Aa(a,b,c){auth.completeTwoFactorAuthentication(a.auth,a.code,function(a){a.error||(Browser.setBrowserActionClickHandler(function(a){x(null,{tab:a})}),Browser.setPopup("")),Browser.getCurrentTab(function(b){a.currentTab=b,c(a)})})}function Ba(a,b){if(b&&b.tab){for(var c={},d=0;d<a.shortcuts.length;d++)c[a.shortcuts[d]]=options.get(a.shortcuts[d]);Browser.sendToTab(b.tab,{name:"receiveKeyboardShortcuts",keys:c,keyboardShortcutsEnabled:options.get("enableKeyboardShortcuts")})}}function Ca(a){auth.isAuthenticated(function(b){if(b){var c=options.get("secureProto")+Sa.get("serviceHost"),d=new Thrift.BinaryHttpTransport(c+"/shard/"+b.shardId+"/utility"),e=new Thrift.BinaryProtocol(d),f=new UtilityClient(e),g=new AppFeedback,h=new SupportTicket;h.applicationVersion=Browser.EVERNOTE_VERSION,h.contactEmail=auth.getUserInfo(b.userId).email,h.osInfo=a.os,h.deviceInfo=a.browser,h.subject=a.title,h.issueDescription="User agent: "+navigator.userAgent+"\nLanguage: "+navigator.language+"\n\n"+a.details,g.rating=a.rating,g.feedback=h,f.sendAppFeedback(b.authenticationToken,g,function(a){console.log(a)},function(a){log.error("problem sending app feedback: Error code "+a.errorCode+"\n"+a)})}else log.error("logged out while filing a support ticket")})}function Da(a,b){b&&b.tab&&Browser.sendToTab(b.tab,{name:"receiveSecret",secret:UUID.generateGuid(),"for":a["for"]})}function Ea(a){alert(a.msg)}function Fa(a,b){var c=auth.getCurrentUser(),d=auth.getUserInfo();if(c&&!/china/i.test(Sa.getName())&&!d.businessId){var e=c%10;if(e>=1&&4>=e){var f=Persistent.get("promo_salesforce");f||(f={}),f[c]||(f[c]=0),f[c]<11&&(f[c]%5==0?(Persistent.set("promo_salesforce",f),Browser.sendToTab(b.tab,{name:"isEligibleForSalesforcePromo",design:2>=e?"A":"B"})):(f[c]++,Persistent.set("promo_salesforce",f)))}}}function Ga(a){var b=auth.getCurrentUser();if(b){var c=Persistent.get("promo_salesforce");c[b]+=a.inc,Persistent.set("promo_salesforce",c)}}function Ha(a,b){var c=auth.getCurrentUser();c=c?c:"unauthed";var d=Persistent.get("lastActiveTimes");d&&d[c]&&d[c].count<5&&d[c].time+216e7<=new Date&&Browser.sendToTab(b.tab,{name:"nudgeInactiveUser",locale:na("name"),authed:"unauthed"===c?!1:!0})}function Ia(){var a=Persistent.get("lastActiveTimes"),b=auth.getCurrentUser();b=b?b:"unauthed",a[b].time=(new Date).getTime(),a.unauthed.time=a[b].time,a[b].count++,Persistent.set("lastActiveTimes",a)}function Ja(){function a(a,b){var c=/^https:\/\/(?:stage|stage-china|www|app)\.(?:evernote|yinxiang)\.com\/.+?ssoReturnStatus=(.+?)(?:&|$)/.exec(a);c&&b(c[1])}function b(c,d){a(d.url,function(a){chrome.tabs.onUpdated.removeListener(b),"SUCCESS"===a&&chrome.tabs.remove(c,function(){Ka()})})}function c(b){a(b.target.url,function(a){safari.application.removeEventListener("navigate",c),"SUCCESS"===a&&(b.target.close(),Ka())})}ra({url:ka("secureProto")+na("serviceHost")+"/SetAuthToken.action?auth="+encodeURIComponent(auth.getUserInfo().authenticationToken)+"&targetUrl="+encodeURIComponent("/business/BusinessSecurityLogin.action?u="+auth.getCurrentUser()+"&h="+sjcl.codec.hex.fromBits(sjcl.hash.sha1.hash(auth.getUserInfo().authenticationToken))+"&clipper=true"),
type:"popup",width:1012,height:435},null,function(){SAFARI?safari.application.addEventListener("navigate",c):chrome.tabs.onUpdated.addListener(b)})}function Ka(a,b){auth.isAuthenticated(function(a){a?b&&b.tab?Browser.sendToTab(b.tab,{name:"updateUserTier",bizUser:!!a.businessId,bizComplete:!!a.bizAuthenticationToken}):Browser.getCurrentTab(function(b){b&&Browser.sendToTab(b,{name:"updateUserTier",bizUser:!!a.businessId,bizComplete:!!a.bizAuthenticationToken})}):log.error("logged out while checking if SSO is done")})}function La(a){var b=new Thrift.BinaryHttpTransport(options.get("secureProto")+Sa.get("serviceHost")+"/edam/note/"+a),c=new Thrift.BinaryProtocol(b);return new NoteStoreClient(c)}function Ma(a){var b=new Thrift.BinaryHttpTransport(options.get("secureProto")+Sa.get("serviceHost")+"/edam/user/"+a),c=new Thrift.BinaryProtocol(b);return new UserStoreClient(c)}function Na(a){var b=new Thrift.BinaryHttpTransport(options.get("secureProto")+Sa.get("serviceHost")+"/shard/"+a+"/utility"),c=new Thrift.BinaryProtocol(b);return new UtilityClient(c)}function Oa(a,b,c){Browser.captureVisibleTab(b.tab,function(d){if(a.start&&a.end){var e=document.createElement("canvas"),f=new Image;f.onload=function(){var c=this.height/a.screenshotHeight;e.width=c*(a.end.x-a.start.x+1),e.height=c*(a.end.y-a.start.y+1),e.getContext("2d").drawImage(this,c*a.start.x,c*a.start.y,e.width,e.height,0,0,e.width,e.height),Browser.sendToTab(b.tab,{name:"receiveScreenshot",data:e.toDataURL()}),e=null},f.src=d,z({category:"Skitch",action:"take_screenshot",label:"portion"})}else a.contextMenu?c(d):Browser.sendToTab(b.tab,{name:"receiveScreenshot",data:d}),z({category:"Skitch",action:"take_screenshot",label:"whole"})})}function Pa(a){return $a[a]}function Qa(a,b){$a[a]=b}function Ra(a){return a&&a.__proto__&&a.__proto__.__proto__&&"TException"===a.__proto__.__proto__.name}var Sa,Ta,Ua,Va,Wa,Xa="content/auth_tools/login.html",Ya=!1,Za=!0,$a={},_a={tabId:null,callback:null},ab=!1;window.addEventListener("offline",function(){log.log("Went offline.")}),window.addEventListener("online",function(){if(log.log("Went online."),Object.keys($a)>0){log.log("processing offline clips");for(var a in $a)va($a[a].note,$a[a].originatingTab)}});var bb={clipPage:"EN_safariContextClipPage",clipScreenshot:"EN_safariContextClipScreenshot",clipSelection:"EN_safariContextClipSelection",clipImage:"EN_safariContextClipImage",clipPDF:"EN_safariContextClipPDF",clipUrl:"EN_safariContextClipUrl"};SAFARI&&(safari.application.addEventListener("contextmenu",g,!1),safari.application.addEventListener("command",f,!1)),Browser.addMessageHandlers({LOGOUT:ea,main_isAuthenticated:W,ssoComplete:Ka,main_getTextResource:ia,simSearch_getNotesRelatedToSearchQuery:ga,simSearch_receivePageInfo:ha,togglePDFContextMenuOption:ta,getKeyboardShortcuts:Ba,main_setOption:R,main_clearOptions:S,main_getConfig:ja,main_openTab:pa,main_openWindow:ra,main_restart:V,main_recordActivity:sa,main_getL10n:Q,bounce:T,bounceToAll:U,insertCSS:ua,getPersistentFlag:za,getOption:la,submitNote:va,toggleClipper:x,trackEvent:z,trackTiming:A,showOpenState:F,showLoggedInState:D,showLoggedInOrOutState:G,getPersistentValue:K,setPersistentValue:L,setPersistentValueForUser:M,addToPersistentValue:N,downloadThumbnail:O,cropImage:P,tourLoaded:$,finishTour:aa,isTouring:_,loadXMLHttpRequest:ba,tabLoaded:ca,sendAppFeedback:Ca,generateSecret:Da,showAlert:Ea,determineSalesforcePromoEligibility:Fa,addToSalesforceCounter:Ga,checkInactivityPeriod:Ha,updateLastActiveTime:Ia,openSSOPage:Ja,captureScreenshot:Oa,setBasicUpsellTimes:Z});var cb=[],db={};this.setOption=ma,this.getOption=ka,this.getBootstrapInfo=na,this.getBootstrapInfoLength=oa,this.start=wa,this.startUp=c,this.createNoteStoreClient=La,this.createUserStoreClient=Ma,this.createUtilityClient=Na,this.showLoggedInState=D,this.showLoggedOutState=E,this.msgHandlerIsAuthenticated=W,this.msgHandlerLogin=da,this.msgHandlerSubmitTwoStepCode=Aa,this.msgHandlerGetRegistrationLinks=fa,this.switchService=H,this.msgHandlerLogout=ea,this.msgHandlerOpenTab=pa,this.msgHandlerOpenWindow=ra,this.msgHandlerRestart=V,this.msgHandlerRecordActivity=sa,this.toggleClipper=x,this.openSSOPage=Ja,this.getPendingNote=Pa,this.setPendingNote=Qa,this.combineRelatedNotes=y,this.trackEvent=z,this.generateUserCustomDimensions=B,this.isThriftError=Ra,Object.preventExtensions(this)}Object.preventExtensions(Extension);var extension=new Extension,auth=null;extension.start();