/*! Copyright 2009-2015 Evernote Corporation. All rights reserved. */
function SidebarBackground(){"use strict";function a(a,b){function c(){var c={},d=extension.getPendingNote(a.pendingNoteKey);d||(d={}),d.relatedNotes||(d.relatedNotes={}),d.relatedNotes.pers=i&&i.relatedNotes?i.relatedNotes.list:[],j&&(d.relatedNotes.biz=j.relatedNotes?j.relatedNotes.list:[],d.relatedNotes.containingNotebooks=h),extension.setPendingNote(a.pendingNoteKey,d),a.notesOnly?a.callback(a.pendingNoteKey,b):("smartFiling"===options.get("notebookSelection")&&(i&&i.notebook&&(c.notebook=i.notebook),p&&options.get("bizSmartFilingEnabled")&&j&&j.notebook&&!j.notebook.restrictions.noCreateNotes&&(c.notebook=j.notebook,c.notebook.biz=!0)),options.get("smartFilingTags")&&(i&&i.tags&&(c.tags=i.tags),p&&j&&j.tags&&c.notebook&&c.notebook.biz&&(c.tags=j.tags)),c.name="receiveSmartFilingInfo",Browser.sendToTab(b.tab,c))}function d(){k=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),k.initWithAuthToken(o,function(){p?(l=new JsonRpc(null,["NoteStoreExtra.getFilingRecommendations"],null,options.get("secureProto"),extension.getBootstrapInfo("serviceHost"),options.get("overrideServiceURL")),l.initWithAuthToken(p,function(){e()})):e()})}function e(){var c={relatedNotesResultSpec:{includeAttributes:!0,includeNotebookGuid:!0,includeTitle:!0,includeUpdated:!0},text:a.recText,url:a.url||b.tab.url};options.get("includeDebugInfo")&&(c.relatedNotesResultSpec.includeDebugInfo=!0);var d=options.get("relatedNotesContext").trim();""!=d&&(c.context=d),JsonQueue.handleExpensiveOpRequest({shardId:k.shardId,userId:q,type:"pers"},k.client.NoteStoreExtra.getFilingRecommendations,g,o,c),p&&JsonQueue.handleExpensiveOpRequest({shardId:l.shardId,userId:q,type:"biz"},l.client.NoteStoreExtra.getFilingRecommendations,f,p,c)}function f(a,d){if(n=!0,a){if(a.relatedNotes){h={};for(var e=0;e<a.containingNotebooks.list.length;e++){var f=a.containingNotebooks.list[e];h[f.guid]={joined:f.hasSharedNotebook,name:f.notebookDisplayName,contact:f.contactName}}}a.debugInfo&&(r.write("DEBUG_INFO",a.debugInfo),delete a.debugInfo),j=a}else resolveError(d,b.tab);m&&c()}function g(d,e){m=!0,d?(i=d,d.debugInfo&&(r.write("TEXT",a.recText),r.write("DEBUG_INFO",d.debugInfo),delete d.debugInfo)):resolveError(e,b.tab),(p&&n||!p)&&c()}var h,i,j,k,l,m,n,o=auth.getUserInfo().authenticationToken,p=auth.getUserInfo().bizAuthenticationToken,q=auth.getCurrentUser(),r=new LogWriter("relatedNotesDebugInfo");a.recText&&a.recText.trim()?d():c()}function b(a,b){function c(){var a=Persistent.get("recentNotebooks");a||(a={}),r=a[q+""],"alwaysStartIn"===options.get("notebookSelection")&&(s=options.get("startNotebook")),t=p.businessId,n=extension.createNoteStoreClient(p.shardId),n.listNotebooks(p.authenticationToken,d,i),n.getFilteredSyncChunk(p.authenticationToken,0,E,G,e,j),p.bizAuthenticationToken&&(o=extension.createNoteStoreClient(/S=([^:]+)/.exec(p.bizAuthenticationToken)[1]),o.getFilteredSyncChunk(p.bizAuthenticationToken,0,E,F,f,j))}function d(c){Browser.sendToTab(b.tab,{name:(a.page?a.page+"_":"")+"receivePersonalNotebooks",alwaysStartInNotebookGuid:s,notebooks:c,recentNotebookGuid:r})}function e(a){for(var b in a.linkedNotebooks){var c=a.linkedNotebooks[b];c.sharedNotebookGlobalId&&c.shardId&&(A[c.sharedNotebookGlobalId]=c,t&&c.businessId===t||(u[c.shardId]||(u[c.shardId]=extension.createNoteStoreClient(c.shardId)),v++,u[c.shardId].authenticateToSharedNotebook(c.sharedNotebookGlobalId,p.authenticationToken,g,k)))}a.updateCount===a.chunkHighUSN?(x=!0,m(),C=!0,l()):n.getFilteredSyncChunk(p.authenticationToken,a.chunkHighUSN,E,G,e,j)}function f(a){a.notebooks&&a.notebooks.length>0&&(B=B.concat(a.notebooks)),a.updateCount===a.chunkHighUSN?(D=!0,l()):o.getFilteredSyncChunk(p.bizAuthenticationToken,a.chunkHighUSN,E,F,f,j)}function g(a){var b=null,c=null,d=null;a.user?(b=a.user.id,c=a.user.name||a.user.username,d=a.user.shardId):a.publicUserInfo&&(b=a.publicUserInfo.userId,c=a.publicUserInfo.username,d=a.publicUserInfo.shardId),A[a.input_args[0]].ownerId=b,A[a.input_args[0]].ownerName=c,a.authenticationToken&&d?u[d].getFilteredSyncChunk(a.authenticationToken,0,1,F,h,k):(w++,m())}function h(a){w++;for(var b in a.notebooks){var c=a.notebooks[b];if(!c.restrictions.noCreateNotes)for(var d in c.sharedNotebooks){var e=A[c.sharedNotebooks[d].globalId];if(e){var f={globalId:e.sharedNotebookGlobalId,guid:c.guid,name:e.shareName,noShareNotes:c.restrictions.noShareNotes,shardId:e.shardId,stack:e.stack,type:GlobalUtils.NOTEBOOK_TYPE_LINKED,visibleToOthers:!0};e.ownerId!==q&&(f.owner=e.ownerName),z.push(f);break}}}m()}function i(a){log.error(a)}function j(a){log.error(a)}function k(a){w++,m(),log.error(a)}function l(){if(D&&C){for(var a in B)if(!B[a].restrictions.noCreateNotes)for(var b in B[a].sharedNotebooks){var c=A[B[a].sharedNotebooks[b].globalId];if(c){var d={globalId:c.sharedNotebookGlobalId,guid:B[a].guid,name:c.shareName,noShareNotes:B[a].restrictions.noShareNotes,shardId:c.shardId,stack:c.stack,type:GlobalUtils.NOTEBOOK_TYPE_BUSINESS,visibleToOthers:(B[a].sharedNotebooks?B[a].sharedNotebooks.length:0)>1||B[a].published};B[a].contact.id!==q&&(d.owner=B[a].contact.name||B[a].contact.username),z.push(d);break}}y=!0,m()}}function m(){!x||w!==v||p.bizAuthenticationToken&&!y||Browser.sendToTab(b.tab,{name:(a.page?a.page+"_":"")+"receiveSharedNotebooks",alwaysStartInNotebookGuid:s,notebooks:z,recentNotebookGuid:r})}var n,o,p=auth.getUserInfo(),q=parseInt(auth.getCurrentUser()),r=null,s=null,t=null,u={},v=0,w=0,x=!1,y=!1,z=[],A={},B=[],C=!1,D=!1,E=50,F=new SyncChunkFilter({includeNotebooks:!0}),G=new SyncChunkFilter({includeLinkedNotebooks:!0});c()}function c(a,b){function c(){var a=auth.getUserInfo(),c=extension.createNoteStoreClient(a.shardId);if(c.listTags(a.authenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receivePersonalTags",tags:a})},d),a.bizAuthenticationToken){var e=/^S=([^:]+)/.exec(a.bizAuthenticationToken)[1],f=extension.createNoteStoreClient(e);f.listTags(a.bizAuthenticationToken,function(a){Browser.sendToTab(b.tab,{name:"receiveBusinessTags",tags:a})},d)}}function d(a){console.log(a)}extension.getOption("alwaysTagWith")&&Browser.sendToTab(b.tab,{name:"receiveAlwaysTags",tags:extension.getOption("alwaysTags").split(/\s*,\s*/)}),c()}Browser.addMessageHandlers({getNotebooks:b,getSmartFilingInfo:a,getTags:c}),this.getSmartFilingInfo=a,Object.preventExtensions(this)}Object.preventExtensions(SidebarBackground);var sidebarBackground=new SidebarBackground;