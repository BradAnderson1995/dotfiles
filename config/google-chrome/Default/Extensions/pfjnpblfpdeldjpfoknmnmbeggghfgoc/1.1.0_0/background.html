<!DOCTYPE html>
<html>
<head>
	<script src="js/jquery.min.js"></script>
	<script src="js/jquery.tmpl.min.js"></script>
	<script src="js/json2.js"></script>
	
</head>
<body>
	<script>
		var _gaq = _gaq || [];
		_gaq.push([ '_setAccount', 'UA-25646916-1' ]);
		_gaq.push([ '_trackPageview' ]);

		(function() {
			var ga = document.createElement('script');
			ga.type = 'text/javascript';
			ga.async = true;
			ga.src = 'https://ssl.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0];
			s.parentNode.insertBefore(ga, s);
		})();
	</script>
	<script>
		if (!window.api) {
			api = {
				title : '',
				year : '',
				callback : this.defaultCallback,
				defaultCallback : function(data) {
					/* discard */
				},
				fetch : function(movieTitle, year, callback) {
					_gaq.push(['_trackEvent', 'Request', 'Fetch', movieTitle]);
					this.title = movieTitle;
					year = year || '';
					this.year = year;
					this.callback = callback || this.defaultCallback;
					var v;
					if (v = this.cache.get(movieTitle + year)) {
						this.cbWrapper(true, movieTitle, v);
					} else {
						url = 'http://www.imdbapi.com/?t=' + escape(movieTitle)
								+ '&y=' + year;
						$.getJSON(url, this.curry(api.cbWrapper, api, false,
								movieTitle));
					}
				},
				curry : function(callback, context) {
					var args = $.makeArray(arguments).slice(2);
					return function() {
						callback.apply(api, $.merge(args, arguments));
					}
				},
				cbWrapper : function(fromCache, title, response) {
					if ($.isPlainObject(response) && 'Response' in response
							&& response.Response == 'True') {
						if (!fromCache) {
							_gaq.push(['_trackEvent', 'Request', 'IMDbAPI', title]);
							this.cache.put(this.title + this.year, response, 86400);
						} else {
							_gaq.push(['_trackEvent', 'Request', 'Cache', title]);
						}
						if (this.title != title) {
							/* discard if old request */
							var data = {
								success : false
							};
						} else {
							var data = {
								success : true,
								id : 'ID' in response ? response.ID : response.imdbID,
								title : this.title,
								actualTitle : response.Title,
								rating : 'rating' in response ? response.rating : response.imdbRating,
								votes : 'Votes' in response ? response.Votes : response.imdbVotes,
								released: response.Released,
								runtime: response.Runtime,
								year: response.Year
							};
						}
					} else {
						_gaq.push(['_trackEvent', 'Request', 'Fail', title]);
						var data = {
							success : false
						};
					}
					this.callback(data);
				},
				cache : {
					ns : 'ni.',
					put : function(k, v, e) {
						v.timeStamp = Math.floor(new Date().getTime() / 1000) + e;
						window.localStorage.setItem(this.ns + k, JSON.stringify(v));
					},
					get : function(k) {
						var v = window.localStorage.getItem(this.ns + k);
						if (v != null) {
							v = JSON.parse(v);
							if (this.isExpired(v)) {
								v = null;
							} else {
								delete v.timeStamp;
							}
							return v;
						}
					},
					isExpired : function(v) {
						return !'timeStamp' in v
								|| v.timeStamp
										- Math.floor(new Date().getTime() / 1000) < 0;
					},
					gc : function() {
						setInterval($.proxy(function() {
							var count = window.localStorage.length;
							var i, k, v;
							var expiredKeys = [];
							for (i = 0; i < count; i++) {
								k = window.localStorage.key(i);
								/* parallel modifications */
								if (k == null) {
									break;
								}
								v = window.localStorage.getItem(k);
								if (v != null) {
									v = JSON.parse(v);
									if (this.isExpired(v)) {
										expiredKeys.push(k);
									}
								}
							}
							for (i in expiredKeys) {
								window.localStorage.removeItem(expiredKeys[i]);
							}
						}, this), 1800000);
					}
				}
			}
		}
	
		function onRequest(request, sender, callback) {
			if (request.action == 'getRatings') {
				api.fetch(request.movieTitle, request.year, callback);
			} else if (request.action == 'render') {
				$('#ni-bar').tmpl(request).prependTo('body');
			}
		}
	
		chrome.extension.onRequest.addListener(onRequest);
		api.cache.gc();
	</script>
</body>
</html>

